<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="UTF-8">
    <title>Redis-session-middleware by fereidani</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" href="stylesheets/normalize.css" media="screen">
    <link href='http://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
    <link rel="stylesheet" type="text/css" href="stylesheets/github-light.css" media="screen">
  </head>
  <body>
    <section class="page-header">
      <h1 class="project-name">Redis-session-middleware</h1>
      <h2 class="project-tagline">Krakenjs express-session redis middleware</h2>
      <a href="https://github.com/fereidani/redis-session-middleware" class="btn">View on GitHub</a>
      <a href="https://github.com/fereidani/redis-session-middleware/zipball/master" class="btn">Download .zip</a>
      <a href="https://github.com/fereidani/redis-session-middleware/tarball/master" class="btn">Download .tar.gz</a>
    </section>

    <section class="main-content">
      <h1>
<a id="redis-session-middleware" class="anchor" href="#redis-session-middleware" aria-hidden="true"><span class="octicon octicon-link"></span></a>redis-session-middleware</h1>

<p>Krakenjs/Expressjs redis session middleware</p>

<p>The "redis-session-middleware" is a middleware for Expressjs 4.x/Kraken 1.x to use express-session with redis compatibility .</p>

<h3>
<a id="how-to-install-" class="anchor" href="#how-to-install-" aria-hidden="true"><span class="octicon octicon-link"></span></a>How to install :</h3>

<p>make a directory in root of your application and call it middleware .
clone project in it .
go to directory and run npm install .</p>

<h5>
<a id="if-you-use-kraken-" class="anchor" href="#if-you-use-kraken-" aria-hidden="true"><span class="octicon octicon-link"></span></a>if you use Kraken :</h5>

<ol>
<li>open <code>config/config.json</code>
</li>
<li>replace old <code>session</code> part or add a following part to "middleware" index :</li>
</ol>

<pre><code>        "session": {
            "module": {
                "name": "../../../middleware/redis-session-middleware",
                "arguments": [
                    {
                        "secret":"hello world!!"
                    },
                    {
                        "db":10
                    },
                    {
                        "defaultError":"Redis Connection Timeout/Problem !"
                    }
                ]
            }
        }
</code></pre>

<ol>
<li>edit config parammeters according to your needs as explained in next section.</li>
</ol>

<h5>
<a id="if-you-use-express-" class="anchor" href="#if-you-use-express-" aria-hidden="true"><span class="octicon octicon-link"></span></a>if you use Express :</h5>

<ul>
<li>use this code in your app with your discretion :</li>
</ul>

<pre><code> var reddisSessionMiddleware=require('./middleware/redis-session-middleware/')(
                    {
                        "secret":"hello world!!"
                    },
                    {
                        "db":10
                    },
                    {
                        "defaultError":"Redis Connection Timeout/Problem !"
                    });
app.use(reddisSessionMiddleware);
</code></pre>

<p>** you can edit config arguments as explained in next section .</p>

<h3>
<a id="config-parameters-" class="anchor" href="#config-parameters-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Config Parameters :</h3>

<ul>
<li><p>Please notice module will work fine with default install of redis and default config , but it's highly recommended to change at least "secret" value and personalise your config file .</p></li>
</ul>

<ol>
<li>first parameter is express-session settings</li>
<li>second parameter is connect-redis , it contains redis connection settings .</li>
<li>third parameter is private settings of redis-session-middleware</li>
</ol>

<h4>
<a id="express-session-settings-" class="anchor" href="#express-session-settings-" aria-hidden="true"><span class="octicon octicon-link"></span></a>express-session settings :</h4>

<p><strong>Note</strong> session data is <em>not</em> saved in the cookie itself, just the session ID.
Session data is stored server-side.</p>

<h5>
<a id="cookie" class="anchor" href="#cookie" aria-hidden="true"><span class="octicon octicon-link"></span></a>cookie</h5>

<p>Settings for the session ID cookie. See the "Cookie options" section below for
more information on the different values.</p>

<p>The default value is <code>{ path: '/', httpOnly: true, secure: false, maxAge: null }</code>.</p>

<h5>
<a id="name" class="anchor" href="#name" aria-hidden="true"><span class="octicon octicon-link"></span></a>name</h5>

<p>The name of the session ID cookie to set in the response (and read from in the
request).</p>

<p>The default value is <code>'skyport'</code>.</p>

<h5>
<a id="proxy" class="anchor" href="#proxy" aria-hidden="true"><span class="octicon octicon-link"></span></a>proxy</h5>

<p>Trust the reverse proxy when setting secure cookies (via the "X-Forwarded-Proto"
header).</p>

<p>The default value is <code>undefined</code>.</p>

<ul>
<li>
<code>true</code> The "X-Forwarded-Proto" header will be used.</li>
<li>
<code>false</code> All headers are ignored and the connection is considered secure only
if there is a direct TLS/SSL connection.</li>
<li>
<code>undefined</code> Use the "trust proxy" setting from express</li>
</ul>

<h5>
<a id="resave" class="anchor" href="#resave" aria-hidden="true"><span class="octicon octicon-link"></span></a>resave</h5>

<p>Forces the session to be saved back to the session store, even if the session
was never modified during the request. Depending on your store this may be
necessary, but it can also create race conditions where a client has two
parallel requests to your server and changes made to the session in one
request may get overwritten when the other request ends, even if it made no
changes (this behavior also depends on what store you're using).</p>

<p>The default value is <code>true</code>, but using the default has been deprecated,
as the default will change in the future. Please research into this setting
and choose what is appropriate to your use-case. Typically, you'll want
<code>false</code>.</p>

<h5>
<a id="rolling" class="anchor" href="#rolling" aria-hidden="true"><span class="octicon octicon-link"></span></a>rolling</h5>

<p>Force a cookie to be set on every response. This resets the expiration date.</p>

<p>The default value is <code>false</code>.</p>

<h5>
<a id="saveuninitialized" class="anchor" href="#saveuninitialized" aria-hidden="true"><span class="octicon octicon-link"></span></a>saveUninitialized</h5>

<p>Forces a session that is "uninitialized" to be saved to the store. A session is
uninitialized when it is new but not modified. Choosing <code>false</code> is useful for
implementing login sessions, reducing server storage usage, or complying with
laws that require permission before setting a cookie. Choose <code>false</code> will also
help with race conditions where a client makes multiple parallel requests
without a session.</p>

<p>The default value is <code>true</code>, but using the default has been deprecated, as the
default will change in the future. Please research into this setting and
choose what is appropriate to your use-case.</p>

<p><strong>Note</strong> if you are using Session in conjunction with PassportJS, Passport
will add an empty Passport object to the session for use after a user is
authenticated, which will be treated as a modification to the session, causing
it to be saved.</p>

<h5>
<a id="secret" class="anchor" href="#secret" aria-hidden="true"><span class="octicon octicon-link"></span></a>secret</h5>

<p><strong>Required option</strong></p>

<p>This is the secret used to sign the session ID cookie.</p>

<h5>
<a id="store" class="anchor" href="#store" aria-hidden="true"><span class="octicon octicon-link"></span></a>store</h5>

<p>deprecated - you can't use it in this module .</p>

<h5>
<a id="unset" class="anchor" href="#unset" aria-hidden="true"><span class="octicon octicon-link"></span></a>unset</h5>

<p>Control the result of unsetting <code>req.session</code> (through <code>delete</code>, setting to <code>null</code>,
etc.).</p>

<p>The default value is <code>'keep'</code>.</p>

<ul>
<li>
<code>'destroy'</code> The session will be destroyed (deleted) when the response ends.</li>
<li>
<code>'keep'</code> The session in the store will be ketp, but modifications made during
the request are ignored and not saved.</li>
</ul>

<h4>
<a id="cookie-options" class="anchor" href="#cookie-options" aria-hidden="true"><span class="octicon octicon-link"></span></a>Cookie options</h4>

<p>Please note that <code>secure: true</code> is a <strong>recommended</strong> option. However, it requires an https-enabled website, i.e., HTTPS is necessary for secure cookies.
If <code>secure</code> is set, and you access your site over HTTP, the cookie will not be set. If you have your node.js behind a proxy and are using <code>secure: true</code>, you need to set "trust proxy" in express:</p>

<div class="highlight highlight-js"><pre><span class="pl-k">var</span> app <span class="pl-k">=</span> express()
app.set(<span class="pl-s"><span class="pl-pds">'</span>trust proxy<span class="pl-pds">'</span></span>, <span class="pl-c1">1</span>) <span class="pl-c">// trust first proxy</span>
app.use(session({
  secret<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>keyboard cat<span class="pl-pds">'</span></span>,
  resave<span class="pl-k">:</span> <span class="pl-c1">false</span>,
  saveUninitialized<span class="pl-k">:</span> <span class="pl-c1">true</span>,
  cookie<span class="pl-k">:</span> { secure<span class="pl-k">:</span> <span class="pl-c1">true</span> }
}))</pre></div>

<p>For using secure cookies in production, but allowing for testing in development, the following is an example of enabling this setup based on <code>NODE_ENV</code> in express:</p>

<div class="highlight highlight-js"><pre><span class="pl-k">var</span> app <span class="pl-k">=</span> express()
<span class="pl-k">var</span> sess <span class="pl-k">=</span> {
  secret<span class="pl-k">:</span> <span class="pl-s"><span class="pl-pds">'</span>keyboard cat<span class="pl-pds">'</span></span>,
  cookie<span class="pl-k">:</span> {}
}

<span class="pl-k">if</span> (app.get(<span class="pl-s"><span class="pl-pds">'</span>env<span class="pl-pds">'</span></span>) <span class="pl-k">===</span> <span class="pl-s"><span class="pl-pds">'</span>production<span class="pl-pds">'</span></span>) {
  app.set(<span class="pl-s"><span class="pl-pds">'</span>trust proxy<span class="pl-pds">'</span></span>, <span class="pl-c1">1</span>) <span class="pl-c">// trust first proxy</span>
  sess.<span class="pl-c1">cookie</span>.secure <span class="pl-k">=</span> <span class="pl-c1">true</span> <span class="pl-c">// serve secure cookies</span>
}

app.use(session(sess))</pre></div>

<p>By default <code>cookie.maxAge</code> is <code>null</code>, meaning no "expires" parameter is set
so the cookie becomes a browser-session cookie. When the user closes the
browser the cookie (and session) will be removed.</p>

<h4>
<a id="connect-redis-settings-" class="anchor" href="#connect-redis-settings-" aria-hidden="true"><span class="octicon octicon-link"></span></a>connect-redis settings :</h4>

<ul>
<li>
<p>You don't need to change these settings in many use cases .</p>

<p>A Redis client is required.  An existing client can be passed directly using the <code>client</code> param or created for you using the <code>host</code>, <code>port</code>, or <code>socket</code> params.</p>

<ul>
<li>
<code>client</code> An existing client created using <code>redis.createClient()</code>
</li>
<li>
<code>host</code> Redis server hostname</li>
<li>
<code>port</code> Redis server portno</li>
<li>
<code>socket</code> Redis server unix_socket</li>
</ul>
</li>
</ul>

<p>The following additional params may be included:</p>

<ul>
<li>
<code>ttl</code> Redis session TTL (expiration) in seconds</li>
<li>
<code>disableTTL</code> disables setting TTL, keys will stay in redis until evicted by other means (overides <code>ttl</code>)</li>
<li>
<code>db</code> Database index to use</li>
<li>
<code>pass</code> Password for Redis authentication</li>
<li>
<code>prefix</code> Key prefix defaulting to "sess:"</li>
<li>
<code>unref</code> Set <code>true</code> to unref the Redis client. <strong>Warning</strong>: this is <a href="https://github.com/mranney/node_redis#clientunref">an experimental feature</a>.</li>
</ul>

<h4>
<a id="redis-session-middleware-settings-" class="anchor" href="#redis-session-middleware-settings-" aria-hidden="true"><span class="octicon octicon-link"></span></a>redis-session-middleware settings :</h4>

<p>The following additional params may be included :</p>

<ul>
<li>
<code>defaultError</code> : it's possible that redis connection failed sometimes because of any expected reason ( timeout , io problems and etc )
               to avoid execution of user request without successfully receiving session data , this module throw a error in these cases .
               this field define error message that will show/log when these cases happened .</li>
</ul>

<h3>
<a id="usage-sample-" class="anchor" href="#usage-sample-" aria-hidden="true"><span class="octicon octicon-link"></span></a>Usage sample :</h3>

<pre><code>app.get('/khashayar',function(req,res){
      req.session.name="khashayar";
      if(req.session.counter){
        req.session.counter++;
      }else{
        req.session.counter=1;
      }
      res.send("Current Counter Value Of Your Session is "+req.session.counter);
});
</code></pre>

<p>for better performance and readability it's adviced to use session like this :</p>

<pre><code>var sess=req.session;
sess.name="khashayar";
</code></pre>

      <footer class="site-footer">
        <span class="site-footer-owner"><a href="https://github.com/fereidani/redis-session-middleware">Redis-session-middleware</a> is maintained by <a href="https://github.com/fereidani">fereidani</a>.</span>

        <span class="site-footer-credits">This page was generated by <a href="https://pages.github.com">GitHub Pages</a> using the <a href="https://github.com/jasonlong/cayman-theme">Cayman theme</a> by <a href="https://twitter.com/jasonlong">Jason Long</a>.</span>
      </footer>

    </section>

  
  </body>
</html>

